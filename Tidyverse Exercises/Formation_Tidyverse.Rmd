---
title: "Formation Tidyverse"
subtitle: ""
author: "Cécile Sauder"
date: "2020/01/30"
output:
  xaringan::moon_reader:
    css: ["default", "rladies", "rladies-fonts", "my_theme.css"]
    lib_dir: libs
    seal: FALSE
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, results = 'hide')
options(htmltools.dir.version = FALSE)
#options(crayon.enabled = TRUE)
library(emo)

```


layout: true
  
<div class="my-header"></div>

<div class="my-footer"><span>Cécile SAUDER    
&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;
&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;
30-31 janvier 2020</span></div> 
---
background-image: url(https://github.com/rstudio/hex-stickers/raw/master/SVG/tidyverse.svg?sanitize=true)
background-size: 550px
background-position: 50% 50%


---



<br> <br> <br> <br>   




1. Présentation Tidyverse et tidy data    

2. Importer les données (readr, haven, readxl)    

3. Ceci n'est pas un pipe (magrittr)    

4. Programmation fonctionnelle  (purrr)    

5. Manipuler les données (dplyr, tidyr, tibble)    

6. Transformer et nettoyer (forcats, stringr, lubridate)    

7. Modéliser (broom)    

8. Communiquer (rmarkdown, blogdown, xaringan, shiny)    


---

background-image: url(https://github.com/rstudio/hex-stickers/raw/master/SVG/tidyverse.svg?sanitize=true)
background-size: 100px
background-position: 90% 3%

# [www.tidyverse.org](www.tidyverse.org)



```{r}

#install.packages("tidyverse")

library(tidyverse)

```
  
  
<br> 
  
```{r, echo=FALSE}

knitr::include_graphics("img/tidyband.png")
```


---


# Data

Jeu de données [**gapminder**](https://www.gapminder.org/videos/ted-us-state-department/).  

1. Installer et charger le `tidyverse` `r emo::ji("package")`  
2. Installer et charger le `gapminder` `r emo::ji("package")`   
3. Regarder le jeu de données gapminder

--

```{r, results='markup'}
#install.packages(gapminder)
library(gapminder)

gapminder
```

---



background-image: url(https://github.com/rstudio/hex-stickers/raw/master/SVG/pipe.svg?sanitize=true)
background-size: 100px
background-position: 90% 3%

# Pipe data

.pull-left[

- old way : **verb(subject, complements)**  

```{r}
head(gapminder,3)
```

.center[![](https://media.giphy.com/media/BgBf6pW9qOgQU/giphy.gif) ]

]

--

- pipe way : **subject %>% verb(complements)**

```{r}
gapminder %>% head(3)
```

.center[![](https://media.giphy.com/media/4pvW2P5L1GmkM/giphy.gif)]



---


# Filter

1\. Filtrer les données pour l'année 2007
--

 - `r emo::ji("bulb")` : condition `==`  

--
```{r}
gapminder %>%
  filter(year == 2007)
```
--
2\. Filtrer les données pour la Chine en 2002
--

 - `r emo::ji("bulb")` : `&`  

--
```{r}
gapminder %>%
  filter(country == "China" & year == 2002)
```
---


# Arrange

1\. Trier les données par population croissante (`pop`)

--

```{r}
gapminder %>%
  arrange(pop)
```

--

2\. Trier les données par population décroissante (`pop`)

--

 - `r emo::ji("bulb")` : `desc()`

--

```{r}
gapminder %>%
  arrange(desc(pop))
```

--

3\. Filtrer les données pour la `France` et les trier par espérance de vie décroissante `lifeExp`

--

```{r}
gapminder %>%
  filter(country == "France") %>%
  arrange(desc(lifeExp))
```


---


# Mutate

1\. Créer deux nouvelles colonnes, une appelée `popMil` avec la population en million
et l'autre appelée `lifeExpMonths` avec l'espérance de vie en mois.

--

 - `r emo::ji("bulb")` 1 : `pop / 100000` , `lifeExp * 12`

--

 - `r emo::ji("bulb")` 2 : on peut créer plusieurs colonnes dans le même `mutate()`
 
--
```{r}
gapminder %>%
  mutate(popMil = pop / 1000000,
         lifeExpMonths = lifeExp * 12)
```

---


# Mutate 


2\. Créer une nouvelle colonne `popUnderMillion` avec deux groupes, l'un avec `TRUE` quand la population `pop` est inférieure à un million, et `FALSE` quand la population est supérieure ou égale à un million

--

 - `r emo::ji("bulb")` : use `if_else()`

--
```{r}
gapminder %>%
  mutate(
    popUnderMillion = if_else(
      pop < 1000000, 
      TRUE, 
      FALSE
    )
  )
```

---


# Mutate 


3\. Créer une nouvelle colonne `lifeExpGroup` avec 3 groupes, `young` quand `lifeExp` est inférieur à 50, `middle` quand `lifeExp` est entre 50 et 70, et `old` quand c'est supérieur à 70

--

 - `r emo::ji("bulb")` : Pour plus de 2 cas, utiliser `case_when()`

--

```{r}
gapminder %>%
  mutate(
    lifeExpGroup = case_when(
      lifeExp < 50 ~ "young",
      lifeExp >= 50 & lifeExp <= 70 ~ "middle",
      lifeExp > 70 ~ "old",
      TRUE ~ NA_character_
    )
  )

```

---


# Select

1\. Selectionner les continents `continent` et les pays `country`

--

 - `r emo::ji("bulb")` : On peut utiliser `starts_with("c")` (mais ce n'est pas la seule solution)

--

```{r}
gapminder %>%
  select(starts_with("c"))
```

ou

```{r}
gapminder %>%
  select(continent, country)
```

--

2\. Selectionner toutes les variables sauf l'espérance de vie `lifeExp`

--

```{r}
gapminder %>%
  select(-lifeExp)
```

---


# Select

3\. Selectionner toutes les variables numériques

--

 - `r emo::ji("bulb")` : On peut utiliser `select_if()`

--

```{r}
gapminder %>%
  select_if(is.numeric)
```
---


# Summarise and group_by

1\. Trouver la moyenne `avg_lifeExp`, la standard deviation `sd_lifeExp` et le nombre de valeurs `n_values` de `lifeExp` par `continent`, puis trier le résultat par `avg_lifeExp` décroissante.

--

```{r}
gapminder %>%
  group_by(continent) %>%
  summarise(
    avg_lifeExp = mean(lifeExp),
    sd_lifeExp = sd(lifeExp),
    n_values = n()
    ) %>%
  arrange(desc(avg_lifeExp))
```

---


# Summarise and group_by

2\. Trouver la moyenne de toutes les variables numériques

--

```{r}
gapminder %>%
  group_by(continent) %>%
  summarise(
    avg_lifeExp = mean(lifeExp),
    sd_lifeExp = sd(lifeExp),
    n_values = n()
    ) %>%
  arrange(desc(avg_lifeExp))
```


---


# ggplot

Parfois vous savez quel graphe vous voulez, parfois non. 

Plusieurs sites pour vous aider à choisir un graphe : 

- [**From Data to Viz**](https://www.data-to-viz.com/)

- [**R Graph Gallery**](https://www.r-graph-gallery.com/)

- [**ggplot2 extensions**](https://www.ggplot2-exts.org/gallery/)

- [**plotly**](https://plot.ly/r/)  pour les graphes interactifs


---


#ggplot geom_boxplot

1\. Tracer les boxplots de `lifeExp` par `continent`

--

```{r, eval = FALSE}
gapminder %>%
  ggplot(aes(x = continent, y = lifeExp)) +
  geom_boxplot()
```

--

2\. Customizer votre graphe
  - Réordonner les boxplots avec `forcats::fct_reorder`
  - Colorer les boxplots avec `aes fill`
  - Modifier les noms des axes avec `labs()`
  - Inverser les axes du graphe avec `coord_flip`
  - Enlever la légende

  
--

```{r, eval = FALSE}
p <- gapminder %>%
  ggplot(aes(x = forcats::fct_reorder(continent, -lifeExp), 
             y = lifeExp, 
             fill = continent)) +
  geom_boxplot() +
  labs(x = "", y = "Life Expectancy") +
  coord_flip() +
  theme(legend.position = 'none')
```

---


#ggplot geom_boxplot + plotly

```{r,  message = FALSE, eval=FALSE}
library(plotly)
ggplotly(p)
```

```{r, eval=FALSE, echo = FALSE}
pg <- ggplotly(p)
htmltools::save_html(pg, file="ggplotly.html")
```

<iframe src="ggplotly.html" width="800" height="500" scrolling="yes" seamless="seamless" frameBorder="0"> </iframe>


---


#ggplot geom_point

1\. Essayer de reproduire ce graphe

```{r, echo=FALSE, fig.height= 6, fig.width= 9}
gapminder %>%
  filter(year == 2002) %>%
  ggplot(aes(gdpPercap, lifeExp, size = pop, colour = country)) +
    geom_point(alpha = 0.7) +
    scale_colour_manual(values = country_colors) +
    scale_size(range = c(2, 12)) +
    scale_x_log10() +
    facet_wrap(~continent) +
    theme(legend.position = 'none') +
    labs(title = 'Year: 2002', x = 'GDP per capita', y = 'Life Expectancy')
```

---


#ggplot

`r emo::ji("bulb")`  : 

1\. Use the aes `size` and `color`

--

2\. Add `geom_point` with a transparancy parameter `alpha`

--

3\. Change x scale in log scale with `scale_x_log10`

--

4\. Adjust colors with `scale_colour_manual` and `country_colors`

--

5\. Adjust size points with `scale_size`

--

6\. Use `facet_wrap` to plot the continents separatly 

---


#ggplot

Here is the complete code for the plot : 

```{r, eval=FALSE}
gapminder %>%
  filter(year == 2002) %>%
  ggplot(aes(gdpPercap, lifeExp, size = pop, colour = country)) +
    geom_point(alpha = 0.7) +
    scale_colour_manual(values = country_colors) +
    scale_size(range = c(2, 12)) +
    scale_x_log10() +
    facet_wrap(~continent) +
    theme(legend.position = 'none') +
    labs(title = 'Year: 2002', x = 'GDP per capita', y = 'Life Expectancy')
```

---


#gganimate your ggplot

Now let's animate this ggplot by year. 

It's the example of the [**gganimate**](https://github.com/thomasp85/gganimate/wiki/Gapminder) `r emo::ji("package")` by [Thomas Lin Pedersen](https://twitter.com/thomasp85). 

It's very easy to animate your previous plot with **gganimate**:

1\. Load the [**gganimate**](https://github.com/thomasp85/gganimate/wiki/Gapminder) `r emo::ji("package")`

2\. Copy the code of your previous plot

3\. Change `title = 'Year: 2002'` to `title = 'Year: {frame_time}'` 

4\. Then add `+  transition_time(year)` 

---


#And TADAAAAAA

.center[![](img/thomas.gif) ]

---


# Thanks!

- [**Cheat sheets**](https://www.rstudio.com/resources/cheatsheets/)  
- [**R Graph Gallery**](https://www.r-graph-gallery.com/) by [Yan Holtz](https://twitter.com/R_Graph_Gallery)
- [**ggplot2 extensions**](https://www.ggplot2-exts.org/gallery/) by [Daniel Emaasit](https://twitter.com/emaasit)


.center[![](https://media.giphy.com/media/nEMmyUp4hl1QOzovKh/giphy.gif)]

Slides created via the R package [**xaringan**](https://github.com/yihui/xaringan) with the [**R-Ladies theme**](https://github.com/rladies/resources/blob/master/xaringan-slides/how_to_use.md) 

